id: dbt_transform
namespace: duolingo

tasks:
  - id: sync
    type: io.kestra.plugin.git.SyncNamespaceFiles
    url: https://github.com/jgoodman55/Duolingo-Data-Insights
    branch: main
    namespace: "{{ flow.namespace }}"
    gitDirectory: dbt
    dryRun: false

  - id: dbt
    type: io.kestra.plugin.dbt.cli.DbtCLI
    namespaceFiles:
      enabled: true
    containerImage: ghcr.io/dbt-labs/dbt-bigquery:1.8.latest
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
      volumes:
        - gcp_secret_volume:/var/secrets/gcp:ro
    env:
      GOOGLE_APPLICATION_CREDENTIALS: /var/secrets/gcp/key.json
      GCP_PROJECT_ID: "{{ kv('GCP_PROJECT_ID') }}"
      GCP_LOCATION: "{{ kv('GCP_LOCATION') }}"
      GCP_DATASET: "{{ kv('GCP_DATASET') }}"
    commands:
      - dbt build --project-dir dbt --profiles-dir dbt --select staging



id: dbt_transform
namespace: duolingo

tasks:
  - id: sync
    type: io.kestra.plugin.git.SyncNamespaceFiles
    url: https://github.com/jgoodman55/Duolingo-Data-Insights
    branch: main
    namespace: "{{ flow.namespace }}"
    gitDirectory: dbt
    dryRun: false

  - id: dbt_run
    type: io.kestra.plugin.scripts.shell.Commands

    containerImage: ghcr.io/dbt-labs/dbt-bigquery:1.8.latest

    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker

    volumes:
      - /dbt:/dbt
      - /var/secrets/gcp/key.json:/var/secrets/gcp/key.json:ro

    env:
      GOOGLE_APPLICATION_CREDENTIALS: /var/secrets/gcp/key.json
      GCP_PROJECT_ID: "{{ kv('GCP_PROJECT_ID') }}"
      GCP_LOCATION: "{{ kv('GCP_LOCATION') }}"
      GCP_BUCKET_NAME: "{{ kv('GCP_BUCKET_NAME') }}"

    commands:
      - ls -la /dbt
      - dbt build --profiles-dir /dbt --project-dir /dbt --select staging

pluginDefaults:
  - type: io.kestra.plugin.gcp
    values:
      projectId: "{{ kv('GCP_PROJECT_ID') }}"
      location: "{{ kv('GCP_LOCATION') }}"
      bucket: "{{ kv('GCP_BUCKET_NAME') }}"
